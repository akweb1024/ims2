// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model Company {
  id          String   @id @default(uuid())
  name        String
  registrationNumber String?
  domain      String?
  
  // Contact
  address     String?
  phone       String?
  email       String?
  website     String?
  logoUrl     String?
  
  // Settings
  fiscalYearStart Int? // Month (1-12)
  currency    String   @default("INR")
  timezone    String   @default("Asia/Kolkata")
  
  users       User[]
  departments Department[]
  customers   CustomerProfile[]
  subscriptions Subscription[]
  communications CommunicationLog[]
  tasks       Task[]
  invoices    Invoice[]
  payments    Payment[]
  chatRooms   ChatRoom[]
  supportTickets SupportTicket[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Department {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  code        String?  // e.g., "SALES", "FIN", "IT"
  description String?
  
  // Hierarchy
  parentDepartmentId String?
  parentDepartment   Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id])
  subDepartments     Department[] @relation("DepartmentHierarchy")
  
  // Head of Department
  headUserId  String?
  headUser    User?    @relation("DepartmentHead", fields: [headUserId], references: [id])
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users       User[]   @relation("DepartmentMembers")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([companyId, code])
  @@index([companyId])
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  role          UserRole
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  lastLogin     DateTime?
  
  // Preferences
  theme         String   @default("light")
  notificationsEnabled Boolean @default(true)
  
  // Organization
  companyId     String?
  company       Company? @relation(fields: [companyId], references: [id])
  
  departmentId  String?
  department    Department? @relation("DepartmentMembers", fields: [departmentId], references: [id])
  
  // Hierarchy
  managerId     String?
  manager       User?    @relation("ManagementChain", fields: [managerId], references: [id])
  subordinates  User[]   @relation("ManagementChain")
  
  // Department Leadership
  headOfDepartments Department[] @relation("DepartmentHead")

  // Chat
  chatParticipants ChatParticipant[]
  sentMessages    ChatMessage[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  customerProfile CustomerProfile?
  assignedSubscriptions Subscription[] @relation("AssignedSalesExecutive")
  assignedCustomers CustomerProfile[] @relation("AssignedCustomers")
  communications CommunicationLog[] @relation("UserCommunications")
  auditLogs AuditLog[]
  tasks Task[]
  assignedTickets SupportTicket[] @relation("AssignedTickets")
  notifications Notification[]
  pushSubscriptions PushSubscription[]

  @@index([email])
  @@index([role])
  @@index([companyId])
  @@index([departmentId])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  TEAM_LEADER
  SALES_EXECUTIVE
  FINANCE_ADMIN
  CUSTOMER
  AGENCY
}

// ============================================
// CUSTOMER PROFILES
// ============================================

model CustomerProfile {
  id                String       @id @default(uuid())
  userId            String       @unique
  customerType      CustomerType

  // Assignment
  assignedToUserId  String?
  assignedTo        User?        @relation("AssignedCustomers", fields: [assignedToUserId], references: [id])

  
  // Common fields
  name              String
  organizationName  String?
  primaryEmail      String
  secondaryEmail    String?
  primaryPhone      String
  secondaryPhone    String?
  gstVatTaxId       String?
  
  // Address
  billingAddress    String?
  shippingAddress   String?
  country           String?
  state             String?
  city              String?
  pincode           String?
  
  // Preferences
  preferredChannel  String?      // email/phone/whatsapp
  notes             String?
  tags              String?      // Comma-separated tags for SQLite compatibility
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  companyId         String?
  company           Company?     @relation(fields: [companyId], references: [id])

  // Relations
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  institutionDetails InstitutionDetails?
  agencyDetails     AgencyDetails?
  subscriptions     Subscription[]
  communications    CommunicationLog[]
  supportTickets    SupportTicket[]

  @@index([customerType])
  @@index([primaryEmail])
  @@index([companyId])
}

enum CustomerType {
  INDIVIDUAL
  INSTITUTION
  AGENCY
}

model InstitutionDetails {
  id                String   @id @default(uuid())
  customerProfileId String   @unique
  
  category          String   // University/College/Company/Library/Govt
  department        String?
  libraryContact    String?
  ipRange           String?
  numberOfUsers     Int?
  numberOfSeats     Int?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)
}

model AgencyDetails {
  id                String   @id @default(uuid())
  customerProfileId String   @unique
  
  companyInfo       String?
  territory         String?
  region            String?
  primaryContact    String?
  commissionTerms   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id], onDelete: Cascade)
  subscriptions     Subscription[]
}

// ============================================
// JOURNAL CATALOG
// ============================================

model Journal {
  id              String   @id @default(uuid())
  name            String
  issnPrint       String?
  issnOnline      String?
  frequency       String   // monthly/quarterly/annual
  formatAvailable String?  // Comma-separated formats for SQLite compatibility
  subjectCategory String?  // Comma-separated categories for SQLite compatibility
  isActive        Boolean  @default(true)
  
  // Pricing
  priceINR        Float    @default(0)
  priceUSD        Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  plans           Plan[]
  subscriptionItems SubscriptionItem[]

  @@index([isActive])
  @@index([name])
}

model Plan {
  id              String   @id @default(uuid())
  journalId       String
  
  planType        String   // Annual/Multi-year/Trial
  format          String   // Print/Online/Hybrid
  institutionTier String?  // small/medium/large
  duration        Int      // in months
  priceINR        Float    @default(0)
  priceUSD        Float    @default(0)
  
  // Rules
  startDateRule   String?  // immediate/calendar-year
  gracePeriod     Int      @default(30) // days
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  journal         Journal  @relation(fields: [journalId], references: [id], onDelete: Cascade)
  subscriptionItems SubscriptionItem[]

  @@index([journalId])
  @@index([isActive])
}

// ============================================
// SUBSCRIPTIONS
// ============================================

model Subscription {
  id                String             @id @default(uuid())
  customerProfileId String
  
  // Sales channel
  salesChannel      SalesChannel
  agencyId          String?
  salesExecutiveId  String?
  
  // Subscription details
  startDate         DateTime
  endDate           DateTime
  autoRenew         Boolean            @default(false)
  status            SubscriptionStatus @default(PENDING_PAYMENT)
  currency          String             @default("INR")
  
  // Pricing
  subtotal          Float
  discount          Float              @default(0)
  tax               Float              @default(0)
  total             Float
  
  // Invoice reference
  invoiceReference  String?
  
  // Renewal chain
  parentSubscriptionId String?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  companyId         String?
  company           Company?           @relation(fields: [companyId], references: [id])

  // Relations
  customerProfile   CustomerProfile    @relation(fields: [customerProfileId], references: [id])
  agency            AgencyDetails?     @relation(fields: [agencyId], references: [id])
  salesExecutive    User?              @relation("AssignedSalesExecutive", fields: [salesExecutiveId], references: [id])
  items             SubscriptionItem[]
  parentSubscription Subscription?     @relation("SubscriptionRenewal", fields: [parentSubscriptionId], references: [id])
  renewals          Subscription[]     @relation("SubscriptionRenewal")
  invoices          Invoice[]

  @@index([customerProfileId])
  @@index([status])
  @@index([salesChannel])
  @@index([startDate, endDate])
  @@index([companyId])
}

enum SalesChannel {
  DIRECT
  AGENCY
}

enum SubscriptionStatus {
  REQUESTED
  ACTIVE
  PENDING_PAYMENT
  EXPIRED
  CANCELLED
  SUSPENDED
}

model SubscriptionItem {
  id              String   @id @default(uuid())
  subscriptionId  String
  journalId       String
  planId          String
  
  quantity        Int      @default(1) // for print copies
  seats           Int?     // for online
  price           Float
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  journal         Journal      @relation(fields: [journalId], references: [id])
  plan            Plan         @relation(fields: [planId], references: [id])

  @@index([subscriptionId])
}

// ============================================
// INVOICING & PAYMENTS
// ============================================

model Invoice {
  id              String        @id @default(uuid())
  subscriptionId  String
  invoiceNumber   String        @unique
  
  currency        String        @default("INR")
  amount          Float
  tax             Float
  total           Float
  
  status          InvoiceStatus @default(UNPAID)
  dueDate         DateTime
  paidDate        DateTime?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])

  // Relations
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id])
  payments        Payment[]

  @@index([subscriptionId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([companyId])
}

enum InvoiceStatus {
  PAID
  UNPAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id              String        @id @default(uuid())
  invoiceId       String
  
  amount          Float
  paymentMethod   String        // card/bank-transfer/check/other
  paymentDate     DateTime
  transactionId   String?
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])

  // Relations
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([companyId])
}

// ============================================
// COMMUNICATION & TASKS
// ============================================

model CommunicationLog {
  id                String   @id @default(uuid())
  customerProfileId String
  userId            String?  // Who logger this communication
  
  type              CommunicationType @default(COMMENT)
  date              DateTime @default(now())
  channel           String   // Email/Phone/WhatsApp/Meeting/Other
  subject           String
  notes             String
  outcome           String?  // interested/follow-up/renewal-confirmed/complaint
  
  // Specific fields
  duration          Int?     // in seconds, for calls
  recordingUrl      String?  // for call records
  referenceId       String?  // for related Invoices or Catalogs
  
  nextFollowUpDate  DateTime?
  isFollowUpCompleted Boolean  @default(false)
  attachments       String?  // Comma-separated file paths/URLs for SQLite compatibility
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  companyId         String?
  company           Company? @relation(fields: [companyId], references: [id])

  // Relations
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id])
  user              User?           @relation("UserCommunications", fields: [userId], references: [id])

  @@index([customerProfileId])
  @@index([type])
  @@index([date])
  @@index([nextFollowUpDate])
  @@index([companyId])
}

enum CommunicationType {
  EMAIL
  CALL
  COMMENT
  INQUIRY
  INVOICE_SENT
  CATALOGUE_SENT
  MEETING
}

model Task {
  id              String     @id @default(uuid())
  userId          String
  
  title           String
  description     String?
  dueDate         DateTime
  priority        Priority   @default(MEDIUM)
  status          TaskStatus @default(PENDING)
  
  // Optional relation to customer/subscription
  relatedCustomerId String?
  relatedSubscriptionId String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  companyId       String?
  company         Company?   @relation(fields: [companyId], references: [id])

  // Relations
  user            User       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@index([companyId])
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// AUDIT & TRACKING
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  
  action      String   // create/update/delete
  entity      String   // customer/subscription/invoice etc
  entityId    String
  changes     Json?    // Store the change details
  ipAddress   String?
  
  createdAt   DateTime @default(now())

  // Relations
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// ============================================
// CHAT & SUPPORT SYSTEM
// ============================================

model ChatRoom {
  id            String            @id @default(uuid())
  name          String?           // Optional for group chats
  isGroup       Boolean           @default(false)
  companyId     String?
  company       Company?          @relation(fields: [companyId], references: [id])
  
  messages      ChatMessage[]
  participants  ChatParticipant[]
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  supportTicket SupportTicket?

  @@index([companyId])
}

model ChatParticipant {
  id         String   @id @default(uuid())
  roomId     String
  userId     String
  
  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  joinedAt   DateTime @default(now())

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
}

model ChatMessage {
  id          String   @id @default(uuid())
  roomId      String
  senderId    String
  content     String
  
  room        ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender      User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([roomId])
  @@index([senderId])
}

model SupportTicket {
  id                String   @id @default(uuid())
  companyId         String?
  company           Company? @relation(fields: [companyId], references: [id])
  customerProfileId String
  customerProfile   CustomerProfile @relation(fields: [customerProfileId], references: [id])
  
  subject           String
  description       String
  status            TicketStatus @default(OPEN)
  priority          Priority     @default(MEDIUM)
  
  assignedToId      String?
  assignedTo        User?   @relation("AssignedTickets", fields: [assignedToId], references: [id])
  
  chatRoomId        String?  @unique
  chatRoom          ChatRoom? @relation(fields: [chatRoomId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([companyId])
  @@index([customerProfileId])
  @@index([status])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  message     String
  type        String   @default("INFO") // INFO, SUCCESS, WARNING, DANGER, CHAT, TICKET
  link        String?
  isRead      Boolean  @default(false)
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint  String   @unique
  p256dh    String
  auth      String
  
  createdAt DateTime @default(now())

  @@index([userId])
}

model SystemSettings {
  id              String   @id @default("singleton")
  maintenanceMode Boolean  @default(false)
  supportEmail    String   @default("support@stm.com")
  defaultCurrency String   @default("INR")
  companyName     String   @default("STM Journal Solutions")
  
  updatedAt       DateTime @updatedAt
}
